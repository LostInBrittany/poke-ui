String.prototype.format||(String.prototype.format=function(){var a=arguments;return this.replace(/{(\d+)}/g,function(b,c){return'undefined'==typeof a[c]?b:a[c]})});var output,size,page=require('webpage').create(),fs=require('fs'),system=require('system'),config=JSON.parse(fs.read('config.json'));if(3>system.args.length)console.log('Usage: phantasm.js filename html [WxH]'),phantom.exit(1);else if(out=system.args[1],opts=JSON.parse(system.args[2]),system.args[3]){function a(a){return a=parseInt(a),!isNaN(a)&&a}var dimensions=system.args[3].split('x'),width=dimensions[0],height=dimensions[1];width=a(width),height=a(height),width&&height&&(page.viewportSize={height:height,width:width}),opts.size||(opts.size={height:height,width:width})}else page.viewportSize={height:opts.size&&opts.size.height?opts.size.height:320,width:opts.size&&opts.size.width?opts.size.width:710};page.onResourceRequested=function(a){console.log('::loading resource ',a.url)},page.onConsoleMessage=function(a){console.log(a)},page.onError=function(a,b){var c=['ERROR: '+a];b&&b.length&&(c.push('TRACE:'),b.forEach(function(a){c.push(' -> '+a.file+': '+a.line+(a.function?' (in function "'+a.function+'")':''))})),console.error(c.join('\n'))};function injectVerify(a){var b=page.injectJs(a);b||(console.log('\nError!\n'+a+' not found!\n'),phantom.exit(1))}page.onLoadFinished=function(){for(var a in console.log('::rendering'),config.js)injectVerify(config.js[a]);page.evaluate(function(a){Function.prototype.bind=Function.prototype.bind||function(a){var b=this;return function(){return b.apply(a,arguments)}},c3.generate(a)},opts),setTimeout(function(){page.render(out),phantom.exit()},300)};var css='';for(var i in config.css)css+=fs.read(config.css[i]);page.content=config.template.format(css);